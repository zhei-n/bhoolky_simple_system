{% extends "base.html" %}

{% block content %}
<div class="container-fluid">
    <h2 class="mb-4" style="color: var(--text); font-weight: 700;"><i class="bi bi-list-check"></i> Tasks Board</h2>

    <!-- Add Task Form -->
    <div class="card mb-4">
        <div class="card-body">
            <form method="POST" action="{{ url_for('add_task') }}" class="row g-3">
                <div class="col-md-4">
                    <input type="text" class="form-control" name="title" placeholder="Task title" required>
                </div>
                <div class="col-md-4">
                    <input type="text" class="form-control" name="description" placeholder="Description">
                </div>
                <div class="col-md-2">
                    <select class="form-select" name="column_name">
                        {% for column in columns %}
                        <option value="{{ column }}">{{ column }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-2">
                    <button type="submit" class="btn btn-primary w-100" style="font-weight: 600;">
                        <i class="bi bi-plus-circle"></i> Add Task
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Kanban Board -->
    <div class="row" id="kanban-board">
        {% for column in columns %}
        <div class="col-md-3">
            <div class="kanban-column" data-column="{{ column }}">
                <h5 class="mb-3" style="color: var(--text); font-weight: 700;">{{ column }}</h5>
                <div class="kanban-drop-zone">
                    {% for task in tasks_by_column[column] %}
                    <div class="kanban-card" draggable="true" data-task-id="{{ task[0] }}" data-column="{{ column }}">
                        <div class="drag-handle"><i class="bi bi-grip-vertical" style="color: var(--accent-1);"></i></div>
                        <h6 style="color: var(--text);">{{ task[1] }}</h6>
                        <p style="color: var(--muted);" class="small mb-2">{{ task[2] }}</p>
                        <div class="d-flex justify-content-between align-items-center">
                            <small style="color: var(--muted);">by {{ task[7] }}</small>
                            <div>
                                <button class="btn btn-sm btn-secondary" 
                                        data-bs-toggle="modal" 
                                        data-bs-target="#editModal{{ task[0] }}"
                                        style="border-radius: 8px; padding: 6px 10px; position: relative; z-index: 10;">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <a href="{{ url_for('delete_task', id=task[0]) }}" 
                                   class="btn btn-sm btn-secondary"
                                   onclick="return confirm('Delete this task?')"
                                   style="border-radius: 8px; padding: 6px 10px;">
                                    <i class="bi bi-trash"></i>
                                </a>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<!-- Modals for all tasks -->
{% for column in columns %}
    {% for task in tasks_by_column[column] %}
    <div class="modal fade" id="editModal{{ task[0] }}" tabindex="-1" aria-labelledby="editModalLabel{{ task[0] }}" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content" style="background: linear-gradient(180deg, rgba(255,255,255,0.05), rgba(255,255,255,0.02)); border: 1px solid rgba(255,255,255,0.1);">
                <div class="modal-header" style="border-bottom: 1px solid rgba(255,255,255,0.1);">
                    <h5 class="modal-title" id="editModalLabel{{ task[0] }}" style="color: var(--text);">Edit Task</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" style="filter: invert(1);"></button>
                </div>
                <form method="POST" action="{{ url_for('edit_task', id=task[0]) }}">
                    <div class="modal-body">
                        <div class="mb-3">
                            <label class="form-label" style="color: var(--text); font-weight: 600;">Title</label>
                            <input type="text" class="form-control" name="title" value="{{ task[1] }}" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label" style="color: var(--text); font-weight: 600;">Description</label>
                            <textarea class="form-control" name="description" rows="3">{{ task[2] }}</textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label" style="color: var(--text); font-weight: 600;">Column</label>
                            <select class="form-select" name="column_name">
                                {% for col in columns %}
                                <option value="{{ col }}" {% if col == task[3] %}selected{% endif %}>{{ col }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <div class="modal-footer" style="border-top: 1px solid rgba(255,255,255,0.1);">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save Changes</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    {% endfor %}
{% endfor %}

<style>
    .kanban-column {
        background: rgba(255,255,255,0.02);
        border-radius: 10px;
        padding: 15px;
        min-height: 500px;
    }
    
    .kanban-drop-zone {
        min-height: 400px;
    }
    
    .kanban-card {
        background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01));
        border: 1px solid rgba(255,255,255,0.05);
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 10px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        cursor: grab;
        transition: all 0.2s cubic-bezier(0.2, 0.9, 0.2, 1);
        position: relative;
    }
    
    .kanban-card:active {
        cursor: grabbing;
    }
    
    .kanban-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 12px 30px rgba(255,122,162,0.2);
        border-color: rgba(255,122,162,0.3);
    }
    
    .kanban-card.dragging {
        opacity: 0.5;
        transform: rotate(2deg) scale(0.95);
    }
    
    .kanban-drop-zone.drag-over {
        background: rgba(255,122,162,0.15);
        border: 2px dashed rgba(255,122,162,0.5);
        border-radius: 8px;
    }
    
    .drag-handle {
        position: absolute;
        top: 10px;
        right: 10px;
        color: var(--accent-1);
        cursor: grab;
    }
    
    .drag-handle:active {
        cursor: grabbing;
    }

    /* Modal styling */
    .modal {
        z-index: 1050;
    }

    .modal-backdrop {
        z-index: 1040;
    }

    .modal.fade .modal-dialog {
        transition: transform 0.3s ease-out;
    }
</style>

<script>
    let draggedElement = null;
    let isDragging = false;

    // Get all draggable cards
    document.querySelectorAll('.kanban-card').forEach(card => {
        card.addEventListener('dragstart', handleDragStart);
        card.addEventListener('dragend', handleDragEnd);
    });

    // Prevent drag when clicking buttons
    document.querySelectorAll('.kanban-card .btn').forEach(btn => {
        btn.addEventListener('mousedown', (e) => {
            e.stopPropagation();
        });
        btn.addEventListener('click', (e) => {
            e.stopPropagation();
        });
    });

    // Get all drop zones
    document.querySelectorAll('.kanban-drop-zone').forEach(zone => {
        zone.addEventListener('dragover', handleDragOver);
        zone.addEventListener('drop', handleDrop);
        zone.addEventListener('dragleave', handleDragLeave);
        zone.addEventListener('dragenter', handleDragEnter);
    });

    function handleDragStart(e) {
        draggedElement = this;
        isDragging = true;
        this.classList.add('dragging');
        e.dataTransfer.effectAllowed = 'move';
        e.dataTransfer.setData('text/html', this.innerHTML);
    }

    function handleDragEnd(e) {
        isDragging = false;
        this.classList.remove('dragging');
        
        // Remove all drag-over classes
        document.querySelectorAll('.kanban-drop-zone').forEach(zone => {
            zone.classList.remove('drag-over');
        });
    }

    function handleDragOver(e) {
        if (e.preventDefault) {
            e.preventDefault();
        }
        e.dataTransfer.dropEffect = 'move';
        return false;
    }

    function handleDragEnter(e) {
        this.classList.add('drag-over');
    }

    function handleDragLeave(e) {
        if (e.target.classList.contains('kanban-drop-zone')) {
            this.classList.remove('drag-over');
        }
    }

    function handleDrop(e) {
        if (e.stopPropagation) {
            e.stopPropagation();
        }

        this.classList.remove('drag-over');

        if (draggedElement !== null) {
            // Get the new column name
            const newColumn = this.closest('.kanban-column').dataset.column;
            const taskId = draggedElement.dataset.taskId;
            const oldColumn = draggedElement.dataset.column;

            // Only update if column changed
            if (newColumn !== oldColumn) {
                // Move the card visually
                this.appendChild(draggedElement);
                draggedElement.dataset.column = newColumn;

                // Update in database via AJAX
                fetch(`/tasks/move/${taskId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        column_name: newColumn
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        console.log('Task moved successfully');
                    } else {
                        console.error('Failed to move task');
                        // Reload page on error
                        location.reload();
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    location.reload();
                });
            }
        }

        return false;
    }
</script>
{% endblock %}